<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  /* Сброс стилей для блока конфигуратора */
  .cz-conf,
  .cz-conf * {
    box-sizing: border-box;
  }

  /* Защита от обрезания Tilda блоками */
  .cz-conf {
    clear: both;
    overflow: visible !important;
    clip-path: none !important;
  }

  .cz-conf {
    font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #FFFFFF;
    color: #000;
    padding: 40px 20px;
    margin: 0 auto;
    width: 100%;
    box-sizing: border-box;
    position: relative;
    z-index: 1;
  }

  .cz-conf * {
    box-sizing: border-box;
  }

  .cz-conf h1 {
    margin: 0;
    padding: 0;
  }

  .cz-conf .container {
    max-width: 1520px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .cz-conf h1 {
    font-size: 30px;
    font-weight: 600;
    line-height: 36px;
    margin: 0 0 20px 0 !important;
    color: #000000;
    -webkit-font-smoothing: antialiased;
    word-break: normal;
    padding: 0 !important;
    position: relative;
    z-index: 2;
  }

  .cz-conf .main-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 0;
    background: #F7F7F7;
    padding: 20px 20px 0 20px;
    border-radius: 8px;
  }

  .cz-conf .product-image {
    background: transparent;
    border-radius: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    position: relative;
    overflow: visible;
    transition: min-height 0.3s ease;
  }

  .cz-conf .product-image.carcass-active {
    min-height: 0;
  }

  .cz-conf .product-image img {
    max-width: 100%;
    height: auto;
    display: block;
  }

  .cz-conf .arrow {
    position: absolute;
    font-size: 40px;
    color: #999;
    cursor: pointer;
    user-select: none;
    transition: color 0.3s;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
  }

  .cz-conf .arrow:hover {
    color: #000;
  }

  .cz-conf .arrow-left {
    left: 10px;
  }

  .cz-conf .arrow-right {
    right: 10px;
  }

  /* Обертка для основного вида и слайдера */
  .cz-conf .image-gallery-wrapper {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
  }

  /* === Горизонтальная карусель === */
  .cz-conf .slider-window {
    width: 100%;
    max-width: 820px;
    overflow: hidden;
    position: relative;
  }

  .cz-conf .slider-track {
    display: flex;
    flex-wrap: nowrap;
    transition: transform 0.45s cubic-bezier(0.4, 0.0, 0.2, 1);
    will-change: transform;
  }

  .cz-conf .slider-slide {
    flex: 0 0 100%;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    box-sizing: border-box;
  }

  .cz-conf .slider-slide-main {
    justify-content: center;
  }

  .cz-conf .gallery-composite-slide {
    background: #f9f9f9;
    border: 2px solid #e0e0e0;
    box-sizing: border-box;
  }

  .cz-conf .config-layers-preview {
    position: relative;
    width: 100%;
    max-width: 400px;          /* как первый слайд */
    aspect-ratio: 1 / 0.95;
    margin: 0 auto;
    overflow: visible;
    pointer-events: none;      /* в превью ничего не кликается */
  }

  /* Превью: «отъехали» назад, все помещается в кадр */

  .cz-conf .config-layers-preview #layer-carcass {
    left: 50%;
    bottom: -65%;
    width: 100%;
    transform: translateX(-50%) scale(0.55);
  }

  .cz-conf .config-layers-preview #layer-machine {
    left: 56%;
    bottom: 46%;
    width: 35%;
    transform: translateX(-50%) scale(0.75);
  }

  .cz-conf .config-layers-preview #layer-fridge {
    left: 35%;
    bottom: 58%;
    width: 20%;
    transform: translateX(-50%) scale(1.35);
  }

  .cz-conf .config-layers-preview #layer-terminal {
    left: 81%;
    bottom: 40%;
    width: 15%;
    transform: translateX(-50%) scale(0.65);
  }

  .cz-conf .config-layers-preview .empty-state {
    display: none !important;
  }

  .cz-conf .config-layers {
    position: relative;
    width: 100%;
    max-width: 400px;
    aspect-ratio: 1 / 0.95;
    margin: 0 auto 0 auto;
    overflow: hidden;
    transition: 
      max-width 0.5s cubic-bezier(0.4, 0.0, 0.2, 1), 
      aspect-ratio 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
  }

  .cz-conf .config-layers.carcass-selected {
    max-width: 460px;
    aspect-ratio: 1 / 0.95;
  }

  .cz-conf .config-layers.no-frame {
    max-width: 620px;
    aspect-ratio: 1 / 0.85;
  }

  .cz-conf .config-layers.frame-only {
    max-width: 620px;
    aspect-ratio: 1 / 0.9;
  }

  .cz-conf .config-layers-wrapper {
    position: absolute;
    inset: 0;
    transform-origin: center center;
  }

  .cz-conf .config-layer {
    position: absolute;
    object-fit: contain;
    pointer-events: none;
    display: block;
  }

  .cz-conf .config-layer-carcass {
    left: 51%;
    bottom: -94%;
    width: 1000px;
    transform: translateX(-50%) scale(0.76);
    z-index: 1;
    opacity: 1;
    transition:
      transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1),
      left     0.6s cubic-bezier(0.4, 0.0, 0.2, 1),
      top      0.6s cubic-bezier(0.4, 0.0, 0.2, 1),
      bottom   0.6s cubic-bezier(0.4, 0.0, 0.2, 1),
      width    0.6s cubic-bezier(0.4, 0.0, 0.2, 1),
      opacity  0.4s ease-in-out;
  }

  .cz-conf .config-layers.frame-only .config-layer-carcass {
    top: 50%;
    bottom: auto;
    left: 50%;
    width: 100%;
    transform: translate(-50%, -50%) scale(0.55);
  }

  .cz-conf .config-layer-item {
    z-index: 2;
    max-width: none;
    transform-origin: center center;
    opacity: 0;
    transition:
      transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1),
      left     0.6s cubic-bezier(0.4, 0.0, 0.2, 1),
      top      0.6s cubic-bezier(0.4, 0.0, 0.2, 1),
      bottom   0.6s cubic-bezier(0.4, 0.0, 0.2, 1),
      width    0.6s cubic-bezier(0.4, 0.0, 0.2, 1),
      opacity  0.4s ease-in-out;
  }

  .cz-conf .config-layer-item.is-active {
    opacity: 1;
    animation: itemAppear 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
  }

  /* Анимация появления элемента */
  @keyframes itemAppear {
    0% {
      opacity: 0;
      transform: translateX(-50%) scale(0.8);
    }
    60% {
      transform: translateX(-50%) scale(1.05);
    }
    100% {
      opacity: 1;
      transform: translateX(-50%) scale(1);
    }
  }

  .cz-conf .items-container {
    position: absolute;
    inset: 0;
    z-index: 3;
    overflow: visible;
  }

  .cz-conf .empty-state {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: #999;
    text-align: center;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    pointer-events: none;
  }

  .cz-conf .empty-state[style*="display: flex"] {
    opacity: 1;
    animation: emptyStatePulse 2s ease-in-out infinite;
  }

  /* Пульсирующая анимация для пустого состояния */
  @keyframes emptyStatePulse {
    0%, 100% {
      opacity: 0.6;
    }
    50% {
      opacity: 1;
    }
  }

  /* Базовые позиции */

  .cz-conf #layer-fridge {
    left: 35%;
    bottom: 60%;
    width: 20%;
    transform: translateX(-50%) scale(1.8);
  }

  .cz-conf #layer-machine {
    left: 56%;
    bottom: 48%;
    width: 35%;
    transform: translateX(-50%) scale(1.0);
  }

  .cz-conf #layer-terminal {
    left: 81%;
    bottom: 42%;
    width: 15%;
    transform: translateX(-50%) scale(0.8);
  }

  /* Выравнивание элементов по одной базовой линии когда нет каркаса */

  /* Один элемент без каркаса - максимальный размер */
  .cz-conf .layout-alone-coffee #layer-machine {
    left: 50%;
    bottom: 23%;
    top: auto;
    transform: translateX(-50%) scale(1.6);
  }

  .cz-conf .layout-alone-fridge #layer-fridge {
    left: 60%;
    bottom: 37%;
    top: auto;
    transform: translateX(-50%) scale(2.6);
  }

  .cz-conf .layout-alone-terminal #layer-terminal {
    left: 50%;
    bottom: 26%;
    top: auto;
    transform: translateX(-50%) scale(1.2);
  }

  /* Два элемента без каркаса - средний размер */
  .cz-conf .layout-pair-coffee-fridge #layer-machine {
    left: 65%;
    bottom: 22%;
    top: auto;
    transform: translateX(-50%) scale(1.4);
  }

  .cz-conf .layout-pair-coffee-fridge #layer-fridge {
    left: 35%;
    bottom: 25%;
    top: auto;
    transform: translateX(-50%) scale(1.9);
  }

  .cz-conf .layout-pair-coffee-terminal #layer-machine {
    left: 40%;
    bottom: 22%;
    top: auto;
    transform: translateX(-50%) scale(1.4);
  }

  .cz-conf .layout-pair-coffee-terminal #layer-terminal {
    left: 71%;
    bottom: 26%;
    top: auto;
    transform: translateX(-50%) scale(0.9);
  }

  .cz-conf .layout-pair-fridge-terminal #layer-fridge {
    left: 58%;
    bottom: 37%;
    top: auto;
    transform: translateX(-50%) scale(2.6);
  }

  .cz-conf .layout-pair-fridge-terminal #layer-terminal {
    left: 69%;
    bottom: 26%;
    top: auto;
    transform: translateX(-50%) scale(0.9);
  }

  /* Три элемента без каркаса - небольшое увеличение */
  .cz-conf .layout-trio-all #layer-fridge {
    left: 31%;
    bottom: 33%;
    top: auto;
    transform: translateX(-50%) scale(2.1);
  }

  .cz-conf .layout-trio-all #layer-machine {
    left: 55%;
    bottom: 21%;
    top: auto;
    transform: translateX(-50%) scale(1.2);
  }

  .cz-conf .layout-trio-all #layer-terminal {
    left: 81%;
    bottom: 8%;
    top: auto;
    transform: translateX(-50%) scale(0.7);
  }

  /* Характеристики */

  .cz-conf .specs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .cz-conf .spec-block {
    padding-bottom: 0;
    opacity: 0;
    transform: translateY(10px);
    animation: specBlockAppear 0.3s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
  }

  /* Задержка анимации для каждого последующего блока */
  .cz-conf .spec-block:nth-child(1) {
    animation-delay: 0s;
  }

  .cz-conf .spec-block:nth-child(2) {
    animation-delay: 0.05s;
  }

  .cz-conf .spec-block:nth-child(3) {
    animation-delay: 0.1s;
  }

  .cz-conf .spec-block:nth-child(4) {
    animation-delay: 0.15s;
  }

  /* Анимация появления блока характеристик */
  @keyframes specBlockAppear {
    0% {
      opacity: 0;
      transform: translateY(10px) scale(0.98);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .cz-conf .spec-title {
    color: #999;
    font-size: 14px;
    text-transform: capitalize;
    margin-bottom: 8px;
  }

  .cz-conf .spec-name {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
    text-transform: uppercase !important;
    opacity: 0;
    transform: translateX(-10px);
    animation: specNameAppear 0.25s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
    animation-delay: 0.02s;
  }

  /* Анимация появления названия */
  @keyframes specNameAppear {
    0% {
      opacity: 0;
      transform: translateX(-10px);
    }
    100% {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .cz-conf .spec-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .cz-conf .spec-list li {
    font-size: 13px;
    line-height: 1.5;
    color: #333;
    opacity: 0;
    transform: translateX(-5px);
    animation: specListItemAppear 0.2s cubic-bezier(0.4, 0.0, 0.2, 1) forwards;
  }

  /* Задержка анимации для каждого элемента списка */
  .cz-conf .spec-list li:nth-child(1) {
    animation-delay: 0.05s;
  }

  .cz-conf .spec-list li:nth-child(2) {
    animation-delay: 0.08s;
  }

  .cz-conf .spec-list li:nth-child(3) {
    animation-delay: 0.11s;
  }

  .cz-conf .spec-list li:nth-child(4) {
    animation-delay: 0.14s;
  }

  .cz-conf .spec-list li:nth-child(5) {
    animation-delay: 0.17s;
  }

  /* Анимация появления элемента списка */
  @keyframes specListItemAppear {
    0% {
      opacity: 0;
      transform: translateX(-5px);
    }
    100% {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .cz-conf .spec-list li:before {
    content: "• ";
    font-weight: bold;
    color: #000;
  }

  /* ======== НИЖНИЙ БЛОК ======== */

  .cz-conf .configurator-wrapper {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-top: 20px;
    margin-bottom: 30px;
    align-items: start;
  }

  .cz-conf .configurator {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
  }

  .cz-conf .config-item {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  /* Подписи */
  .cz-conf .config-label {
    font-size: 14px;
    font-weight: 600;
    color: #000;
  }

  /* Серый текст, если disabled */
  .cz-conf .config-item:has(.config-select:disabled) .config-label {
    color: #b3b3b3;
  }

  /* === СТИЛЬ SELECT c SVG-СТРЕЛКОЙ И HOVER-АНИМАЦИЕЙ === */
  .cz-conf .config-select {
    -webkit-font-smoothing: antialiased;
    -webkit-text-size-adjust: 100%;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;

    width: 100%;
     height: 50px;
     line-height: 50px;
    padding: 0 45px 0 20px;

    box-sizing: border-box;
    cursor: pointer;
    outline: none;

    background-color: rgb(248, 248, 248);
    border: 1px solid rgb(232, 232, 232);
    border-radius: 5px;

    font-family: "Montserrat", sans-serif;
    font-size: 15px;
    font-weight: 400;
    line-height: 13.3px;
    color: rgb(0, 0, 0);

    /* SVG-стрелочка справа (как в Zero Block) */
    background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23999' stroke-width='1.2' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    background-size: 10px 6px;

    /* Анимация на hover */
    transition:
      border-color 0.2s ease,
      box-shadow 0.2s ease,
      transform 0.12s ease-out;
  }

  /* Hover: лёгкая тень и подскок вверх на 1px */
  .cz-conf .config-select:hover:not(:disabled) {
    border-color: #bdbdbd;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
    transform: translateY(-1px);
  }

  /* Disabled: без тени и движения, всё серое */
  .cz-conf .config-select:disabled {
    background-color: #FFFFFF;
    border-color: #e5e5e5;
    color: #b3b3b3;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
  }

  /* Цены */

  .cz-conf .price-section {
    display: flex;
    justify-content: space-between;
    gap: 40px;
  }

  .cz-conf .price-block {
    flex: 1;
    text-align: center;
    display: flex;
    flex-direction: column;
  }

  .cz-conf .price {
    font-size: 44px;
    font-weight: 700;
    margin-bottom: 12px;
    min-height: 1em;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease-in-out;
  }

  .cz-conf .price.updating {
    animation: priceUpdate 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
  }

  @keyframes priceUpdate {
    0% {
      transform: scale(1);
    }
    50% {
      transform: scale(1.05);
      color: #0066FF;
    }
    100% {
      transform: scale(1);
    }
  }

  .cz-conf .price.sale {
    color: #0066FF;
  }

  .cz-conf .price.regular {
    color: #000;
  }

  /* ▼▼▼ ВОЗВРАЩЁННЫЙ БЛОК "ⓘ Нет комплекта OZON" ▼▼▼ */
  .cz-conf .price-placeholder {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #b3b3b3;
  }

  .cz-conf .price-placeholder__icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 1px solid #d0d0d0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
  }
  /* ▲▲▲ конец блока плейсхолдера ▲▲▲ */

  .cz-conf .btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px 32px;
    font-size: 16px;
    font-weight: 600;
    line-height: 1.55;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out;
    width: 100%;
    text-decoration: none;
    outline: none;
    -webkit-font-smoothing: antialiased;
    margin-top: auto;
  }

  .cz-conf .btn-primary {
    background-color: #0064fc;
    color: #ffffff;
    border-color: transparent;
    border-style: solid;
  }

  .cz-conf .btn-primary:hover {
    background-color: #0052d4;
  }

  .cz-conf .btn-primary:disabled {
    background-color: #d3d3d3;
    color: #777;
    cursor: default;
  }

  .cz-conf .btn-secondary {
    background-color: #fff;
    color: #000;
    border: 2px solid #000;
  }

  .cz-conf .btn-secondary:hover {
    background-color: #000;
    color: #fff;
  }

  /* Адаптив */

  @media (max-width: 968px) {
    .cz-conf .container {
      display: grid;
      grid-template-columns: 1fr;
      row-gap: 20px;
      grid-template-areas:
        "title"
        "image"
        "config"
        "price"
        "specs";
    }

    .cz-conf .main-content,
    .cz-conf .configurator-wrapper {
      display: contents;
    }

    /* Сохраняем серый фон для блока с изображением */
    .cz-conf .product-image {
      background: #F7F7F7;
      padding: 20px;
      border-radius: 8px;
    }

    /* Сохраняем серый фон для блока характеристик */
    .cz-conf .specs {
      background: #F7F7F7;
      padding: 20px;
      border-radius: 8px;
      grid-template-columns: repeat(2, 1fr);
    }

    .cz-conf .configurator {
      grid-template-columns: repeat(2, 1fr);
    }

    /* Фиксируем высоту кнопок и блоков цен */
    .cz-conf .price-section {
      display: flex;
      flex-direction: row;
      gap: 20px;
      width: 100%;
      align-items: stretch;
    }

    .cz-conf .price-block {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .cz-conf .btn {
      min-height: 54px;
      height: auto;
      padding: 12px 16px;
      font-size: 14px;
      line-height: 1.4;
    }

    .cz-conf .price {
      min-height: 60px;
      height: auto;
      font-size: 36px;
    }
  }
</style>
</head>
<body>

<div class="cz-conf">
  <div class="container">
    <h1>Конфигуратор</h1>

    <div class="main-content">
      <div class="product-image">
        <span class="arrow arrow-left">‹</span>

        <!-- Обертка для основного вида и слайдов -->
        <div class="image-gallery-wrapper">
          <div class="slider-window">
            <div class="slider-track" id="slider-track">
              <!-- Слайд 0: основной интерактивный вид -->
              <div class="slider-slide slider-slide-main">
                <div class="config-layers" id="config-layers">
                  <img id="layer-carcass" class="config-layer config-layer-carcass" src="https://placehold.co/1600x1200/e0e0e0/666?text=Carcass" alt="">
                  
                  <!-- Контейнер для элементов поверх каркаса -->
                  <div class="items-container">
                    <img id="layer-fridge"    class="config-layer config-layer-item" src="https://placehold.co/120x200/99ccff/333?text=Fridge" alt="">
                    <img id="layer-machine"   class="config-layer config-layer-item" src="https://placehold.co/210x180/ffcc99/333?text=Machine" alt="">
                    <img id="layer-terminal"  class="config-layer config-layer-item" src="https://placehold.co/90x150/ccff99/333?text=Terminal" alt="">
                  </div>

                  <!-- Плейсхолдер когда ничего не выбрано -->
                  <div id="empty-state" class="empty-state">
                    Выберите хотя бы один&nbsp;товар
                  </div>
                </div>
              </div>
              <!-- Остальные слайды добавляет JS -->
            </div>
          </div>
        </div>

        <span class="arrow arrow-right">›</span>
      </div>

      <!-- Автоматически заполняемый блок характеристик -->
      <div class="specs" id="specs-container">
        <div class="spec-block">
          <div class="spec-title">Кофемашина</div>
          <div class="spec-name">Пример машины</div>
          <ul class="spec-list">
            <li>Автоматическое приготовление</li>
            <li>Капучинатор</li>
            <li>LCD дисплей</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="configurator-wrapper">
      <div class="configurator">
        <div class="config-item">
          <label class="config-label">Кофемашина</label>
          <select class="config-select" id="machine-select">
            <!-- заполняется из JS, теперь с опцией "Нет" -->
          </select>
        </div>

        <div class="config-item">
          <label class="config-label">Холодильник</label>
          <select class="config-select" id="fridge-select">
            <option>Нет</option>
            <option>Модель A</option>
          </select>
        </div>

        <div class="config-item">
          <label class="config-label">Терминал</label>
          <select class="config-select" id="terminal-select">
            <option>Нет</option>
            <option>Терминал 1</option>
          </select>
        </div>

        <div class="config-item">
          <label class="config-label">Каркас</label>
          <select class="config-select" id="carcass-select">
            <option>Нет</option>
          </select>
        </div>

        <div class="config-item">
          <label class="config-label">Цвет каркаса</label>
          <select class="config-select" id="carcass-color-select" disabled>
            <option>—</option>
          </select>
        </div>

        <div class="config-item">
          <label class="config-label">Цвет дизайна</label>
          <select class="config-select" id="design-color-select" disabled>
            <option>—</option>
          </select>
        </div>
      </div>

      <div class="price-section">
        <div class="price-block">
          <div class="price sale" id="price-sale"></div>
          <button class="btn btn-primary" id="btn-ozon">Заказать на OZON</button>
        </div>

        <div class="price-block">
          <div class="price regular" id="price-regular"></div>
          <button class="btn btn-secondary" id="btn-invoice">Запросить счёт</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const API_BASE = 'https://93-170-123-229.nip.io/api';

    let META = null;
    let currentVariationId = null;
    let currentSlideIndex = 0; // 0 - основной конфигуратор, далее - доп. слайды

    function getEl(id) {
      return document.getElementById(id);
    }

    async function fetchJson(url) {
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error('API error ' + res.status);
      return res.json();
    }

    function getIntValue(id) {
      const el = getEl(id);
      if (!el) return null;
      const v = el.value;
      if (v === '' || v == null) return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    // Сохранение состояния в localStorage
    function saveState() {
      const state = {
        machineId: getEl('machine-select')?.value || '',
        fridgeId: getEl('fridge-select')?.value || '',
        terminalId: getEl('terminal-select')?.value || '',
        carcassId: getEl('carcass-select')?.value || '',
        carcassColorId: getEl('carcass-color-select')?.value || '',
        designColorId: getEl('design-color-select')?.value || ''
      };
      
      try {
        localStorage.setItem('configurator-state', JSON.stringify(state));
        console.log('State saved:', state);
      } catch (e) {
        console.warn('Failed to save state:', e);
      }
    }

    // Восстановление состояния из localStorage
    function restoreState() {
      try {
        const saved = localStorage.getItem('configurator-state');
        if (!saved) return null;
        const state = JSON.parse(saved);
        console.log('State restored:', state);
        return state;
      } catch (e) {
        console.warn('Failed to restore state:', e);
        return null;
      }
    }

    function fillSelect(select, items, mapFn) {
      if (!select) return;
      select.innerHTML = '';
      items.forEach(item => {
        const { value, label } = mapFn(item);
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = label;
        select.appendChild(opt);
      });
    }

    function uniqueById(arr) {
      const map = new Map();
      arr.forEach(item => {
        if (!item || item.id == null) return;
        if (!map.has(item.id)) map.set(item.id, item);
      });
      return Array.from(map.values());
    }

    function findCarcass(id) {
      return (META?.carcasses || []).find(c => c.id === id) || null;
    }

    function setOzonPlaceholder() {
      const priceSaleEl = getEl('price-sale');
      if (!priceSaleEl) return;
      priceSaleEl.innerHTML =
        '<span class="price-placeholder">' +
          '<span class="price-placeholder__icon">ⓘ</span>' +
          '<span class="price-placeholder__text">Нет комплекта OZON</span>' +
        '</span>';
    }

    function updateCarcassColorsAndDesigns() {
      const carcassColorSelect = getEl('carcass-color-select');
      const designColorSelect  = getEl('design-color-select');
      if (!META || !carcassColorSelect || !designColorSelect) return;

      const carcassId = getIntValue('carcass-select');

      if (!carcassId) {
        carcassColorSelect.innerHTML = '';
        designColorSelect.innerHTML  = '';
        carcassColorSelect.disabled  = true;
        designColorSelect.disabled   = true;
        return;
      }

      const carcass = findCarcass(carcassId);
      if (!carcass || !Array.isArray(carcass.variations)) {
        carcassColorSelect.innerHTML = '';
        designColorSelect.innerHTML  = '';
        carcassColorSelect.disabled  = true;
        designColorSelect.disabled   = true;
        return;
      }

      const variations = carcass.variations;
      const carcassColors = uniqueById(
        variations.map(v => v.carcass_color)
      );

      carcassColorSelect.disabled = false;
      designColorSelect.disabled  = false;

      fillSelect(carcassColorSelect, carcassColors, c => ({
        value: c.id,
        label: c.name || c.code
      }));

      updateDesignColors();
    }

    function updateDesignColors() {
      const designColorSelect = getEl('design-color-select');
      if (!META || !designColorSelect) return;

      const carcassId       = getIntValue('carcass-select');
      const carcassColorId  = getIntValue('carcass-color-select');

      if (!carcassId) {
        designColorSelect.innerHTML = '';
        designColorSelect.disabled = true;
        return;
      }

      const carcass = findCarcass(carcassId);
      if (!carcass || !Array.isArray(carcass.variations)) {
        designColorSelect.innerHTML = '';
        designColorSelect.disabled = true;
        return;
      }

      if (!carcassColorId) {
        designColorSelect.innerHTML = '';
        designColorSelect.disabled = true;
        return;
      }

      const variations = carcass.variations.filter(
        v => v.carcass_color?.id === carcassColorId
      );

      const designColors = uniqueById(
        variations.map(v => v.design_color)
      );

      designColorSelect.disabled = false;

      fillSelect(designColorSelect, designColors, c => ({
        value: c.id,
        label: c.name || c.code
      }));
    }

    function getActiveCarcassVariation() {
      const carcassId      = getIntValue('carcass-select');
      if (!carcassId) return null;

      const carcassColorId = getIntValue('carcass-color-select');
      const designColorId  = getIntValue('design-color-select');
      const carcass = findCarcass(carcassId);
      if (!carcass || !Array.isArray(carcass.variations)) return null;

      let variation = carcass.variations.find(
        v =>
          v.carcass_color?.id === carcassColorId &&
          v.design_color?.id === designColorId
      );

      if (!variation) variation = carcass.variations[0] || null;
      return variation || null;
    }

    function updateSliderPosition() {
      const track = document.getElementById('slider-track');
      if (!track) return;

      const total = track.children.length;
      if (total <= 0) return;

      if (currentSlideIndex < 0) currentSlideIndex = 0;
      if (currentSlideIndex > total - 1) currentSlideIndex = total - 1;

      track.style.transform = 'translateX(-' + (currentSlideIndex * 100) + '%)';
    }

    function renderGallery(variation) {
      const trackEl = document.getElementById('slider-track');
      if (!trackEl) return;

      // Оставляем только первый слайд (основной конфигуратор)
      while (trackEl.children.length > 1) {
        trackEl.removeChild(trackEl.lastChild);
      }

      const urls = variation?.gallery_image_urls || [];
      
      const carcassId  = getIntValue('carcass-select');
      const machineId  = getIntValue('machine-select');
      const fridgeId   = getIntValue('fridge-select');
      const terminalId = getIntValue('terminal-select');
      
      const hasFrame   = !!carcassId;
      const hasAnyItem = !!(machineId || fridgeId || terminalId);
      
      console.log('renderGallery slider:', {
        hasFrame,
        hasAnyItem,
        variation: !!variation,
        main_image: variation?.main_image_url,
        gallery_count: urls.length
      });

      // Если позже появятся ссылки на дополнительные изображения — можно добавлять отдельные слайды:
      urls.forEach(url => {
        const slide = document.createElement('div');
        slide.className = 'slider-slide';

        const img = document.createElement('img');
        img.src = url;
        img.loading = 'lazy';
        img.style.maxWidth = '400px';

        slide.appendChild(img);
        trackEl.appendChild(slide);
        console.log('Added gallery slide image:', url);
      });
      
      // Составной слайд (второй): каркас + выбранные элементы
      if (hasFrame && hasAnyItem && variation?.main_image_url && META) {
        console.log('Creating composite slide for slider...');

        const original = document.getElementById('config-layers');
        if (original) {
          const compositeOuterSlide = document.createElement('div');
          compositeOuterSlide.className = 'slider-slide';

          const clone = original.cloneNode(true);
          clone.removeAttribute('id');
          clone.classList.add('config-layers-preview');

          // Сбрасываем layout-классы у items-container в превью
          const itemsClone = clone.querySelector('.items-container');
          if (itemsClone) {
            itemsClone.className = 'items-container';
          }

          compositeOuterSlide.appendChild(clone);
          trackEl.appendChild(compositeOuterSlide);
          console.log('Composite preview slide added to slider. Total slides:', trackEl.children.length);
        }
      }


      // После перестроения галереи всегда возвращаемся на первый слайд
      currentSlideIndex = 0;
      updateSliderPosition();
    }

    function updateLayers() {
      if (!META) return;

      const machineId  = getIntValue('machine-select');
      const fridgeId   = getIntValue('fridge-select');
      const terminalId = getIntValue('terminal-select');
      const carcassId  = getIntValue('carcass-select');

      const machine  = (META.machines  || []).find(m => m.id === machineId);
      const fridge   = (META.fridges   || []).find(f => f.id === fridgeId);
      const terminal = (META.terminals || []).find(t => t.id === terminalId);

      const variation = getActiveCarcassVariation();
      currentVariationId = variation ? variation.id : null;

      const layerCarcass   = getEl('layer-carcass');
      const layerFridge    = getEl('layer-fridge');
      const layerMachine   = getEl('layer-machine');
      const layerTerminal  = getEl('layer-terminal');
      const configLayers   = getEl('config-layers');
      const productImage   = document.querySelector('.cz-conf .product-image');
      const itemsContainer = document.querySelector('.cz-conf .items-container');
      const emptyState     = getEl('empty-state');

      if (layerCarcass) {
        layerCarcass.src = variation?.main_image_url || '';
      }

      if (layerFridge) {
        layerFridge.src = fridge?.main_image_url || '';
        layerFridge.classList.toggle('is-active', !!fridge);
      }

      if (layerMachine) {
        layerMachine.src = machine?.main_image_url || '';
        layerMachine.classList.toggle('is-active', !!machine);
      }

      if (layerTerminal) {
        layerTerminal.src = terminal?.main_image_url || '';
        layerTerminal.classList.toggle('is-active', !!terminal);
      }

      const hasFrame    = !!carcassId;
      const hasCoffee   = !!machineId;
      const hasFridge   = !!fridgeId;
      const hasTerminal = !!terminalId;

      const elementCount =
        (hasCoffee ? 1 : 0) +
        (hasFridge ? 1 : 0) +
        (hasTerminal ? 1 : 0);

      // нет ни каркаса, ни элементов
      const nothingSelected =
        !hasFrame && !hasCoffee && !hasFridge && !hasTerminal;

      if (configLayers) {
        configLayers.classList.toggle('carcass-selected', hasFrame);
        // no-frame: есть товары, но нет каркаса
        configLayers.classList.toggle('no-frame', !hasFrame && elementCount > 0);
        // frame-only: только каркас, без товаров
        configLayers.classList.toggle('frame-only', hasFrame && elementCount === 0);
      }

      if (productImage) {
        if (hasFrame) {
          productImage.classList.add('carcass-active');
        } else {
          productImage.classList.remove('carcass-active');
        }
      }

      if (emptyState) {
        emptyState.style.display = nothingSelected ? 'flex' : 'none';
      }

      if (itemsContainer) {
        const layoutClasses = [
          'layout-frame-coffee-only',
          'layout-frame-fridge-only',
          'layout-frame-terminal-only',
          'layout-alone-coffee',
          'layout-alone-fridge',
          'layout-alone-terminal',
          'layout-pair-coffee-fridge',
          'layout-pair-coffee-terminal',
          'layout-pair-fridge-terminal',
          'layout-trio-all'
        ];
        
        // Принудительно удаляем все классы
        itemsContainer.classList.remove(...layoutClasses);
        
        // Принудительный reflow для гарантии применения изменений
        void itemsContainer.offsetHeight;

        if (nothingSelected) {
          renderGallery(variation);
          return;
        }

        if (hasFrame && elementCount > 0) {
          // Базовая конфигурация с каркасом
          if (elementCount === 1) {
            if (hasCoffee) {
              itemsContainer.classList.add('layout-frame-coffee-only');
            } else if (hasFridge) {
              itemsContainer.classList.add('layout-frame-fridge-only');
            } else if (hasTerminal) {
              itemsContainer.classList.add('layout-frame-terminal-only');
            }
          }
          // 2 или 3 элемента с каркасом — базовые позиции по умолчанию
        } else if (!hasFrame && elementCount > 0) {
          // Конфигурации без каркаса
          if (elementCount === 1) {
            if (hasCoffee)         itemsContainer.classList.add('layout-alone-coffee');
            else if (hasFridge)    itemsContainer.classList.add('layout-alone-fridge');
            else if (hasTerminal)  itemsContainer.classList.add('layout-alone-terminal');
          } else if (elementCount === 2) {
            if (hasCoffee && hasFridge && !hasTerminal) {
              itemsContainer.classList.add('layout-pair-coffee-fridge');
            } else if (hasCoffee && hasTerminal && !hasFridge) {
              itemsContainer.classList.add('layout-pair-coffee-terminal');
            } else if (hasFridge && hasTerminal && !hasCoffee) {
              itemsContainer.classList.add('layout-pair-fridge-terminal');
            }
          } else if (elementCount === 3) {
            itemsContainer.classList.add('layout-trio-all');
          }
        }
        
        // Еще один reflow после добавления классов
        void itemsContainer.offsetHeight;
      }

      renderGallery(variation);
    }

    function renderSpecs() {
      const container = getEl('specs-container');
      if (!container || !META) return;
      container.innerHTML = '';

      const machineId  = getIntValue('machine-select');
      const fridgeId   = getIntValue('fridge-select');
      const terminalId = getIntValue('terminal-select');
      const carcassId  = getIntValue('carcass-select');

      const machine  = (META.machines  || []).find(m => m.id === machineId);
      const fridge   = (META.fridges   || []).find(f => f.id === fridgeId);
      const terminal = (META.terminals || []).find(t => t.id === terminalId);
      const carcass  = findCarcass(carcassId);

      const blocks = [
        { title: 'Кофемашина', item: machine },
        { title: 'Холодильник', item: fridge },
        { title: 'Каркас', item: carcass },
        { title: 'Терминал', item: terminal }
      ];

      blocks.forEach(({ title, item }) => {
        if (!item || item.id == null) return;

        const block = document.createElement('div');
        block.className = 'spec-block';

        const t = document.createElement('div');
        t.className = 'spec-title';
        t.textContent = title.charAt(0).toUpperCase() + title.slice(1).toLowerCase();
        block.appendChild(t);

        const nameDiv = document.createElement('div');
        nameDiv.className = 'spec-name';
        nameDiv.textContent = item.name || '';
        block.appendChild(nameDiv);

        const specs = item.specs_short || item.specs || null;

        if (Array.isArray(specs) && specs.length) {
          const ul = document.createElement('ul');
          ul.className = 'spec-list';
          specs.forEach(s => {
            const li = document.createElement('li');
            li.textContent = s;
            ul.appendChild(li);
          });
          block.appendChild(ul);
        } else {
          const ph = document.createElement('div');
          ph.className = 'spec-placeholder';
          ph.innerHTML = '<span class="spec-placeholder__icon">☰</span><span>Описание скоро будет доступно.</span>';
          block.appendChild(ph);
        }

        container.appendChild(block);
      });
    }

    async function updatePreview() {
      if (!META) return;

      const coffee_machine_id = getIntValue('machine-select');
      const fridge_id         = getIntValue('fridge-select');
      const carcass_id        = getIntValue('carcass-select');
      const carcass_color_id  = getIntValue('carcass-color-select');
      const design_color_id   = getIntValue('design-color-select');
      const terminal_id       = getIntValue('terminal-select');

      const priceSaleEl    = getEl('price-sale');
      const priceRegularEl = getEl('price-regular');
      const btnOzon        = getEl('btn-ozon');

      let basePrice = 0;
      function addPrice(item) {
        if (item && typeof item.price === 'number') {
          basePrice += item.price;
        }
      }

      const machine  = (META.machines  || []).find(m => m.id === coffee_machine_id);
      const fridge   = (META.fridges   || []).find(f => f.id === fridge_id);
      const terminal = (META.terminals || []).find(t => t.id === terminal_id);
      const carcass  = findCarcass(carcass_id);

      addPrice(machine);
      addPrice(fridge);
      addPrice(terminal);
      addPrice(carcass);

      if (priceRegularEl) {
        if (basePrice > 0) {
          // Добавляем анимацию обновления
          priceRegularEl.classList.add('updating');
          priceRegularEl.textContent = basePrice.toLocaleString('ru-RU') + '₽';
          setTimeout(() => priceRegularEl.classList.remove('updating'), 400);
        } else {
          priceRegularEl.textContent = '';
        }
      }

      if (!coffee_machine_id || !carcass_id || !carcass_color_id || !design_color_id) {
        if (priceSaleEl) setOzonPlaceholder();
        if (btnOzon) {
          btnOzon.disabled = true;
          btnOzon.removeAttribute('onclick');
        }
        return;
      }

      const params = new URLSearchParams();
      params.set('coffee_machine_id', coffee_machine_id);
      params.set('carcass_id',        carcass_id);
      params.set('carcass_color_id',  carcass_color_id);
      params.set('design_color_id',   design_color_id);

      if (fridge_id)   params.set('fridge_id', fridge_id);
      if (terminal_id) params.set('terminal_id', terminal_id);
      if (currentVariationId) params.set('carcass_design_combination_id', currentVariationId);

      let preview;
      try {
        preview = await fetchJson(API_BASE + '/preview?' + params.toString());
      } catch (e) {
        console.error('preview error', e);
        return;
      }

      if (!preview || !preview.is_exact_bundle) {
        if (priceSaleEl) {
          setOzonPlaceholder();
        }
        if (btnOzon) {
          btnOzon.disabled = true;
          btnOzon.removeAttribute('onclick');
        }
        return;
      }

      if (priceSaleEl && preview.custom_price != null) {
        // Добавляем анимацию обновления
        priceSaleEl.classList.add('updating');
        priceSaleEl.textContent =
          preview.custom_price.toLocaleString('ru-RU') + '₽';
        setTimeout(() => priceSaleEl.classList.remove('updating'), 400);
      }

      if (btnOzon) {
        if (preview.ozon_url) {
          btnOzon.disabled = false;
          btnOzon.textContent = 'Заказать на OZON';
          btnOzon.onclick = function () {
            window.open(preview.ozon_url, '_blank');
          };
        } else {
          btnOzon.disabled = true;
          btnOzon.textContent = 'Нет ссылки OZON';
          btnOzon.removeAttribute('onclick');
        }
      }
    }

    async function init() {
      try {
        META = await fetchJson(API_BASE + '/meta');
      } catch (e) {
        console.error('Failed to load /meta', e);
        return;
      }

      const machinesSelect  = getEl('machine-select');
      const fridgesSelect   = getEl('fridge-select');
      const terminalsSelect = getEl('terminal-select');
      const carcassesSelect = getEl('carcass-select');

      // Пытаемся восстановить сохраненное состояние
      const savedState = restoreState();

      // Кофемашина: "Нет" + список
      if (machinesSelect) {
        const items = [{ id: '', name: 'Нет' }].concat(META.machines || []);
        fillSelect(machinesSelect, items, m => ({
          value: m.id,
          label: m.name
        }));
        
        // Устанавливаем значение
        if (savedState?.machineId !== undefined) {
          machinesSelect.value = savedState.machineId;
        } else if (META.machines && META.machines.length) {
          machinesSelect.value = META.machines[0].id;
        }
      }

      // Холодильник
      if (fridgesSelect) {
        const items = [{ id: '', name: 'Нет' }].concat(META.fridges || []);
        fillSelect(fridgesSelect, items, f => ({
          value: f.id,
          label: f.name
        }));
        
        // Устанавливаем значение
        if (savedState?.fridgeId !== undefined) {
          fridgesSelect.value = savedState.fridgeId;
        } else if (META.fridges && META.fridges.length) {
          fridgesSelect.value = META.fridges[0].id;
        }
      }

      // Терминал
      if (terminalsSelect) {
        const items = [{ id: '', name: 'Нет' }].concat(META.terminals || []);
        fillSelect(terminalsSelect, items, t => ({
          value: t.id,
          label: t.name
        }));
        
        // Устанавливаем значение
        if (savedState?.terminalId !== undefined) {
          terminalsSelect.value = savedState.terminalId;
        } else if (META.terminals && META.terminals.length) {
          terminalsSelect.value = META.terminals[0].id;
        }
      }

      // Каркас
      if (carcassesSelect) {
        const items = [{ id: '', name: 'Нет' }].concat(META.carcasses || []);
        fillSelect(carcassesSelect, items, c => ({
          value: c.id,
          label: c.name
        }));

        // Устанавливаем значение
        if (savedState?.carcassId !== undefined) {
          carcassesSelect.value = savedState.carcassId;
        } else if (META.carcasses && META.carcasses.length) {
          carcassesSelect.value = META.carcasses[0].id;
        }
      }

      // Обновляем цвета каркаса
      updateCarcassColorsAndDesigns();
      
      // Если есть сохраненное состояние для цветов каркаса, восстанавливаем их
      if (savedState?.carcassId && (savedState.carcassColorId || savedState.designColorId)) {
        // Используем requestAnimationFrame для гарантии, что селекты заполнены
        requestAnimationFrame(() => {
          const carcassColorSelect = getEl('carcass-color-select');
          const designColorSelect = getEl('design-color-select');
          
          if (carcassColorSelect && savedState.carcassColorId) {
            // Проверяем, что такое значение есть в селекте
            const hasOption = Array.from(carcassColorSelect.options).some(
              opt => opt.value == savedState.carcassColorId
            );
            if (hasOption) {
              carcassColorSelect.value = savedState.carcassColorId;
              updateDesignColors();
              
              // Восстанавливаем цвет дизайна
              requestAnimationFrame(() => {
                if (designColorSelect && savedState.designColorId) {
                  const hasDesignOption = Array.from(designColorSelect.options).some(
                    opt => opt.value == savedState.designColorId
                  );
                  if (hasDesignOption) {
                    designColorSelect.value = savedState.designColorId;
                  }
                }
                
                // Обновляем интерфейс
                updateLayers();
                renderSpecs();
                updatePreview();
              });
            } else {
              updateLayers();
              renderSpecs();
              updatePreview();
            }
          } else {
            updateLayers();
            renderSpecs();
            updatePreview();
          }
        });
      } else {
        updateLayers();
        renderSpecs();
        await updatePreview();
      }
      
      attachEvents();
    }

    function attachEvents() {
      const ids = [
        'machine-select',
        'fridge-select',
        'terminal-select',
        'carcass-select',
        'carcass-color-select',
        'design-color-select'
      ];

      ids.forEach(id => {
        const el = getEl(id);
        if (!el) return;
        el.addEventListener('change', async () => {
          if (id === 'carcass-select') {
            updateCarcassColorsAndDesigns();
          } else if (id === 'carcass-color-select') {
            updateDesignColors();
          }
          updateLayers();
          renderSpecs();
          await updatePreview();
          
          // Сохраняем состояние после каждого изменения
          saveState();
        });
      });

      // Подключаем стрелки к слайдеру
      const arrowLeft = document.querySelector('.cz-conf .arrow-left');
      const arrowRight = document.querySelector('.cz-conf .arrow-right');
      const track = document.getElementById('slider-track');

      if (arrowLeft && track) {
        arrowLeft.addEventListener('click', () => {
          console.log('Arrow left clicked');
          currentSlideIndex -= 1;
          updateSliderPosition();
        });
      }

      if (arrowRight && track) {
        arrowRight.addEventListener('click', () => {
          console.log('Arrow right clicked');
          currentSlideIndex += 1;
          updateSliderPosition();
        });
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
</script>

</body>
</html>
